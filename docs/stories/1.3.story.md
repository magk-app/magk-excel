# Story 1.3: Excel Generation and Manipulation

## Story Info

- **Epic:** 1 - Core Automation Engine  
- **Story Number:** 1.3  
- **Status:** Draft  
- **Created:** 2025-07-30  

## Story Statement

**As a** developer, **I want** to create a Python module that can create and write to Excel files, **so that** the extracted data can be saved in the required format.

## Acceptance Criteria

1. The module can create a new Excel workbook.
2. The module can write a list of lists to a sheet.
3. The module can save in both .xlsx and .xls formats.
4. (Nice to have) The module can update an Excel file in real-time.

## Dev Notes

### Previous Story Insights
From Story 1.1 (Web Data Extraction Foundation) and Story 1.2 (PDF Data Extraction Foundation):
- Project structure is established with `apps/server/chalicelib/` for backend modules
- Chalice application is configured and working with AWS Lambda compatibility
- Error handling pattern established using try/except blocks with CloudWatch logging
- WebExtractor and PDF extractor classes provide good architectural patterns to follow
- Testing strategy uses pytest with comprehensive mocking for external dependencies
- Data extraction modules return structured data in list of lists format

### Data Models
**WorkflowConfig**: This story will work with the WorkflowConfig data model which includes:
- `sourceType`: Can be 'web' or 'pdf' (from previous stories)
- `sourceUri`: URL or file path to the data source
- `dataIdentifier`: String to identify the specific table or data
- The Excel generation module will use extracted data from web/PDF sources to create Excel output
[Source: architecture/data-models.md#WorkflowConfig]

### API Specifications
This module will be integrated into the `/execute-workflow` endpoint:
- **Purpose**: To generate Excel output from extracted data and provide download URL
- **Request Body**: The WorkflowConfig object in JSON format
- **Response**: `{ "outputUrl": "<https://s3>..." }` (A pre-signed URL to download the generated Excel file)
- The Excel generator will be the final step in the workflow processing pipeline
[Source: architecture/data-models.md#WorkflowConfig]

### Component Specifications
**Excel Manipulation Technology**: openpyxl 3.1.x will be used for Excel file creation and manipulation
- **Rationale**: Reliable and feature-rich for modern Excel format support
- **Location**: This module will be part of the serverless backend in the chalicelib directory
- **Integration**: Will be called after web/PDF extraction to create the final Excel output
[Source: architecture/tech-stack.md#Excel Manipulation]

### File Locations
Based on the project structure and following the pattern from previous stories:
- **Backend Module**: `apps/server/chalicelib/excel_generator.py`
- **Main API Logic**: Integration in `apps/server/app.py` (extend existing execute-workflow endpoint)
- **Tests**: `apps/server/tests/test_excel_generator.py`
[Source: architecture/unified-project-structure.md#Project Structure]

### Testing Requirements
**Unit Testing**: 
- Automated unit tests using `pytest` will be implemented for the core Excel generation module
- Tests will be located in the server tests directory alongside existing extractor tests
- Primary focus on foundational reliability following established testing patterns
- Mock data and test Excel files will be created for comprehensive testing
[Source: architecture/testing-strategy.md#Unit Testing]

### Technical Constraints
**Python Version**: Python 3.10.x is required for consistency with the backend
**AWS Platform**: Module will run on AWS Lambda functions with openpyxl compatibility
**Error Handling**: Use standard Python try/except blocks with CloudWatch logging following established pattern
**Excel Format Support**: Support both .xlsx (modern) and .xls (legacy) formats as specified in AC
[Source: architecture/tech-stack.md#Backend Language, architecture/error-handling-strategy.md#Server-Side]

### Security and Performance Considerations
**File Handling**: Secure handling of Excel file generation and S3 upload for download URLs
**Performance**: Excel generation can be memory-intensive, ensure Lambda memory limits are respected
**AWS Lambda Scaling**: Automatic scaling with consideration for Excel processing overhead
**S3 Integration**: Generated Excel files will need S3 pre-signed URLs for download
[Source: architecture/error-handling-strategy.md#Server-Side]

## Tasks / Subtasks

### Task 1: Set up Excel generation module structure (AC: 1)
- [ ] 1.1. Create `apps/server/chalicelib/excel_generator.py` module file
- [ ] 1.2. Define module interface accepting data (list of lists) and output configuration parameters
- [ ] 1.3. Set up basic error handling using try/except blocks following established pattern
- [ ] 1.4. Add logging integration for CloudWatch debugging

### Task 2: Implement Excel workbook creation (AC: 1, 2)
- [ ] 2.1. Configure openpyxl for Excel workbook creation
- [ ] 2.2. Implement function to create new Excel workbook with worksheet
- [ ] 2.3. Implement function to write list of lists data to worksheet
- [ ] 2.4. Add basic error handling for data format issues

### Task 3: Implement multi-format Excel saving (AC: 3)
- [ ] 3.1. Implement .xlsx format saving using openpyxl
- [ ] 3.2. Implement .xls format saving (legacy format support)
- [ ] 3.3. Add format selection logic based on output configuration
- [ ] 3.4. Handle file naming and temporary file management for Lambda environment

### Task 4: Implement S3 integration for file delivery
- [ ] 4.1. Add S3 client configuration for file uploads
- [ ] 4.2. Implement Excel file upload to S3 after generation
- [ ] 4.3. Generate pre-signed URLs for Excel file downloads
- [ ] 4.4. Add cleanup logic for temporary files in Lambda environment

### Task 5: Implement real-time Excel update capability (AC: 4 - Nice to have)
- [ ] 5.1. Research openpyxl capabilities for file updates
- [ ] 5.2. Implement function to update existing Excel files
- [ ] 5.3. Add logic to detect if Excel file exists for update vs create new
- [ ] 5.4. Handle concurrent access and file locking considerations

### Task 6: Integrate with backend API workflow (AC: 1, 2, 3)
- [ ] 6.1. Integrate Excel generator into the Chalice app.py execute-workflow endpoint
- [ ] 6.2. Connect Excel generator with web and PDF extractor outputs
- [ ] 6.3. Ensure proper response formatting with S3 pre-signed URLs
- [ ] 6.4. Add error handling for Excel generation failures

### Task 7: Unit testing implementation
- [ ] 7.1. Create `apps/server/tests/test_excel_generator.py` test file
- [ ] 7.2. Create sample data (list of lists) for testing Excel generation
- [ ] 7.3. Write unit tests for Excel workbook creation and data writing
- [ ] 7.4. Write unit tests for .xlsx and .xls format saving
- [ ] 7.5. Write unit tests for S3 integration and pre-signed URL generation
- [ ] 7.6. Write unit tests for error handling scenarios
- [ ] 7.7. Create mock S3 fixtures for testing
- [ ] 7.8. Ensure all tests pass using pytest

### Task 8: AWS Lambda compatibility verification
- [ ] 8.1. Verify openpyxl configuration works in serverless environment
- [ ] 8.2. Test module performance within Lambda execution limits for various data sizes
- [ ] 8.3. Validate S3 integration and file upload functionality
- [ ] 8.4. Ensure module meets AWS Lambda deployment requirements

## Project Structure Notes

The current project structure aligns with the defined architecture. The Excel generation module will be placed in the `apps/server/chalicelib/` directory as specified in the unified project structure guide, following the same pattern established by the WebExtractor and PDF extractor modules from previous stories. No structural conflicts identified.

## Dev Agent Record

### Agent Model Used
*To be filled in by the Dev Agent during implementation*

### Implementation Notes
*To be filled in by the Dev Agent during implementation*

### Completion Notes  
*To be filled in by the Dev Agent upon story completion*

### Debug Log References
*References to debug log entries will be added here during implementation*

## File List
*Files created/modified during story implementation:*
- [ ] To be updated during implementation

## Change Log
- 2025-07-30: Created story 1.3 based on Epic 1 requirements and architecture documentation

---
*Story created: 2025-07-30*