# Story 2.2: Node.js Workflow Generation & Execution Engine

## Story Info

- **Epic:** 2 - Conversational Builder & Tool Generation (Refactored)
- **Story Number:** 2.2
- **Status:** Draft
- **Created:** 2025-08-01
- **Architecture:** Node.js + Hono.js + Serverless + Enhanced JSON Workflows

## Story Statement

**As a** system architect, **I want** a lightweight Node.js backend that generates workflows with both natural language descriptions and JSON format, **so that** workflows are human-readable, machine-executable, and self-healing with LLM validation.

## Acceptance Criteria

1. **Dual Format Workflows**: Both natural language step-by-step plans AND JSON format
2. **Type-Based Tools**: Support MCP, API, and LLM tool types with different parameters
3. **LLM Workflow Generation**: Convert natural language to dual-format workflows
4. **Self-Healing Execution**: LLM validates errors and dynamically fixes workflows  
5. **Human-in-the-Loop**: Confirmation points for workflow validation
6. **Workflow Library**: Save, visualize, and manage workflow collections
7. **Natural Progress Updates**: LLM interprets execution state into natural language
8. **Local + Cloud Deploy**: Run locally, deploy to Vercel/Supabase when ready

## Technology Stack (2025 Research-Based)

### Backend Framework
- **API Framework**: Hono.js ⭐ Ultra-lightweight, edge-first, <14kB
- **Runtime**: Node.js 20+ (latest LTS)
- **Deployment**: Vercel Functions (seamless) or local development
- **Database**: Supabase (when deployed) or local JSON files
- **LLM Integration**: Anthropic SDK for Claude 3.5/Opus
- **WebSocket**: Hono WebSocket support for real-time updates

### Why Hono.js?
- **Ultra-lightweight**: <14kB core, perfect for serverless
- **Universal deployment**: Same code works on Vercel, Cloudflare, local
- **Performance**: 400k+ ops/sec, fastest for serverless
- **TypeScript-first**: Excellent developer experience
- **Edge-optimized**: Perfect for global deployment

## Architecture Overview

```
workflow-engine/
├── src/
│   ├── index.ts                 # Hono app entry
│   ├── routes/
│   │   ├── chat.ts              # Chat with workflow generation
│   │   ├── workflows.ts         # Workflow CRUD operations
│   │   ├── execution.ts         # Workflow execution
│   │   └── library.ts           # Workflow library management
│   ├── services/
│   │   ├── workflow-generator.ts # Natural language → Dual format
│   │   ├── workflow-executor.ts  # Execute with self-healing
│   │   ├── llm-service.ts        # Claude API integration
│   │   └── mcp-client.ts         # MCP server connections
│   ├── models/
│   │   ├── workflow.ts           # Enhanced workflow schema
│   │   ├── execution.ts          # Execution state tracking
│   │   └── library.ts            # Workflow library models
│   └── utils/
│       ├── validation.ts         # Workflow validation
│       └── natural-language.ts   # Progress interpretation
├── workflows/                   # Local workflow storage
├── package.json                 # Hono.js dependencies
└── vercel.json                  # Vercel deployment config
```

## Enhanced Workflow Format

### Dual-Format Workflow Schema
```json
{
  "workflow": {
    "id": "uuid-v4",
    "name": "Extract E-commerce Product Data",
    "description": "Comprehensive product data extraction from e-commerce website",
    "version": "1.0",
    "created_at": "2025-08-01T10:00:00Z",
    
    "natural_language_plan": {
      "overview": "We'll scrape product data from the website, clean it up, and export it to Excel for analysis.",
      "steps": [
        "1. Navigate to the e-commerce website and locate the product listing page",
        "2. Use web scraping to extract the product table data including names, prices, and descriptions", 
        "3. Clean and structure the raw data by removing HTML tags and normalizing formats",
        "4. Export the processed data to a well-formatted Excel spreadsheet",
        "5. Verify the Excel file contains all expected product information"
      ],
      "estimated_time": "About 30 seconds",
      "human_readable_summary": "This workflow will automatically collect product information from a website and organize it into a clean Excel file for your analysis."
    },
    
    "json_steps": [
      {
        "id": "step-1",
        "type": "mcp", // NEW: Type system for different tool categories
        "tool": "firecrawl-mcp",
        "name": "Scrape Product Data", 
        "description": "Extract product information from website",
        "parameters": {
          "url": "https://example.com/products",
          "selector": "table.products",
          "format": "markdown",
          "wait_for": "table"
        },
        "outputs": ["scraped_data"],
        "next_steps": ["step-2"],
        "human_confirmation": false,
        "retry_attempts": 3
      },
      {
        "id": "step-2",
        "type": "llm", // NEW: LLM processing step
        "tool": "claude-data-processor", 
        "name": "Clean and Structure Data",
        "description": "Process scraped data into structured format",
        "parameters": {
          "input": "{{step-1.scraped_data}}",
          "operations": ["clean_html", "extract_table", "normalize_prices"],
          "output_format": "json_array"
        },
        "outputs": ["structured_data"],
        "next_steps": ["step-3"],
        "human_confirmation": false,
        "retry_attempts": 2
      },
      {
        "id": "step-3", 
        "type": "api", // NEW: Direct API call
        "tool": "excel-api",
        "name": "Export to Excel",
        "description": "Create Excel file with structured data",
        "parameters": {
          "data": "{{step-2.structured_data}}",
          "filename": "products_{{timestamp}}.xlsx",
          "sheet_name": "Products",
          "headers": ["Product Name", "Price", "Description"],
          "formatting": "table_style"
        },
        "outputs": ["excel_file_url"],
        "next_steps": [],
        "human_confirmation": true, // NEW: Human confirmation required
        "retry_attempts": 1
      }
    ],
    
    "metadata": {
      "complexity": "medium",
      "tools_required": ["firecrawl-mcp", "claude-api", "excel-api"],
      "estimated_duration": "30s",
      "success_criteria": ["Data extracted", "Excel file created", "No errors"],
      "category": "data_extraction",
      "tags": ["web_scraping", "excel", "ecommerce"]
    }
  }
}
```

### Execution State with Natural Language Interpretation
```json
{
  "execution": {
    "id": "exec-uuid",
    "workflow_id": "workflow-uuid",
    "status": "running",
    "started_at": "2025-08-01T10:00:00Z",
    "current_step": "step-2",
    
    "natural_language_progress": {
      "current_activity": "I'm currently cleaning up the scraped product data and organizing it into a proper structure.",
      "completed_summary": "Successfully extracted product information from the website including 45 products with names, prices, and descriptions.",
      "next_activity": "Next, I'll create a nicely formatted Excel file with all the product data.",
      "overall_progress": "About 66% complete - making great progress!"
    },
    
    "steps_progress": {
      "step-1": {
        "status": "completed",
        "started_at": "2025-08-01T10:00:00Z",
        "completed_at": "2025-08-01T10:00:15Z",
        "natural_log": "Found the product page and successfully extracted 45 products. The data looks good with names, prices, and descriptions all captured.",
        "outputs": {
          "scraped_data": "...markdown table data..."
        },
        "retry_count": 0
      },
      "step-2": {
        "status": "running",
        "started_at": "2025-08-01T10:00:15Z", 
        "natural_log": "Processing the scraped data to clean up HTML tags and normalize the price formats. This should take about 10 more seconds.",
        "outputs": {},
        "retry_count": 0
      }
    },
    
    "errors": [],
    "progress_percentage": 66,
    "human_confirmations_pending": []
  }
}
```

## Dev Notes

### Hono.js API Implementation
```typescript
import { Hono } from 'hono';
import { cors } from 'hono/cors';
import { logger } from 'hono/logger';

const app = new Hono();

app.use('*', cors());
app.use('*', logger());

// Chat with workflow generation
app.post('/chat', async (c) => {
  const { message } = await c.req.json();
  const workflow = await workflowGenerator.generateFromNaturalLanguage(message);
  return c.json({ workflow, clarifications: [] });
});

// Execute workflow with self-healing
app.post('/workflows/:id/execute', async (c) => {
  const workflowId = c.req.param('id');
  const execution = await workflowExecutor.executeWithSelfHealing(workflowId);
  return c.json({ execution_id: execution.id });
});

export default app;
```

### Self-Healing Workflow Executor
```typescript
class WorkflowExecutor {
  async executeWithSelfHealing(workflowId: string): Promise<Execution> {
    const workflow = await this.getWorkflow(workflowId);
    const execution = await this.createExecution(workflow);
    
    for (const step of workflow.json_steps) {
      try {
        const result = await this.executeStep(step, execution.context);
        await this.updateExecutionProgress(execution.id, step.id, result);
        
        // Generate natural language progress update
        const naturalUpdate = await this.llm.interpretProgress(step, result);
        await this.broadcastProgress(execution.id, naturalUpdate);
        
      } catch (error) {
        // Self-healing: Ask LLM to fix the workflow
        const fixedStep = await this.llm.fixWorkflowStep(step, error);
        
        if (fixedStep && step.retry_attempts > 0) {
          step.retry_attempts--;
          step.parameters = fixedStep.parameters;
          
          // Retry with fixed parameters
          const result = await this.executeStep(step, execution.context);
          await this.updateExecutionProgress(execution.id, step.id, result);
        } else {
          throw new ExecutionError(`Step ${step.id} failed: ${error.message}`);
        }
      }
      
      // Human confirmation if required
      if (step.human_confirmation) {
        await this.requestHumanConfirmation(execution.id, step);
        await this.waitForConfirmation(execution.id, step.id);
      }
    }
    
    return execution;
  }
}
```

### Natural Language Progress Interpreter
```typescript
class NaturalLanguageService {
  async interpretProgress(step: WorkflowStep, result: any): Promise<string> {
    const prompt = `
    Interpret this workflow step execution for the user in natural, friendly language:
    
    Step: ${step.name} - ${step.description}
    Type: ${step.type}
    Result: ${JSON.stringify(result)}
    
    Write a brief, conversational update about what just happened and what's next.
    Be encouraging and specific about the progress made.
    `;
    
    const response = await this.llm.generate(prompt);
    return response.content;
  }
  
  async generateOverallProgress(execution: Execution): Promise<string> {
    const completedSteps = execution.steps_progress.filter(s => s.status === 'completed').length;
    const totalSteps = execution.workflow.json_steps.length;
    const percentage = Math.round((completedSteps / totalSteps) * 100);
    
    const prompt = `
    Generate a friendly progress update for a workflow execution:
    
    Completed: ${completedSteps}/${totalSteps} steps (${percentage}%)
    Current step: ${execution.current_step}
    Workflow: ${execution.workflow.name}
    
    Write a brief, encouraging progress message.
    `;
    
    const response = await this.llm.generate(prompt);
    return response.content;
  }
}
```

## Tasks / Subtasks

### Task 1: Setup Hono.js + TypeScript Project
- [ ] 1.1. Initialize Hono.js project with TypeScript
- [ ] 1.2. Setup development environment with hot reload
- [ ] 1.3. Configure CORS for Electron frontend
- [ ] 1.4. Add logging and error handling middleware
- [ ] 1.5. Setup local development server

### Task 2: Implement Enhanced Workflow Schema
- [ ] 2.1. Create dual-format workflow models (natural + JSON)
- [ ] 2.2. Add type system for tools (MCP, API, LLM)
- [ ] 2.3. Implement workflow validation with TypeScript
- [ ] 2.4. Add human confirmation points
- [ ] 2.5. Create workflow template system

### Task 3: Build LLM Workflow Generator
- [ ] 3.1. Integrate Anthropic SDK for Claude
- [ ] 3.2. Create dual-format generation prompts
- [ ] 3.3. Implement natural language → workflow conversion
- [ ] 3.4. Add workflow optimization suggestions
- [ ] 3.5. Generate human-readable explanations

### Task 4: Create Self-Healing Execution Engine
- [ ] 4.1. Build type-aware tool executor (MCP/API/LLM)
- [ ] 4.2. Implement error detection and LLM-based fixing
- [ ] 4.3. Add retry logic with parameter adjustment
- [ ] 4.4. Create human confirmation system
- [ ] 4.5. Implement execution state management

### Task 5: Add Natural Language Progress Updates
- [ ] 5.1. Create progress interpretation service
- [ ] 5.2. Generate conversational progress updates
- [ ] 5.3. Add WebSocket for real-time communication
- [ ] 5.4. Create encouraging, specific progress messages
- [ ] 5.5. Handle error explanations in natural language

### Task 6: Build Workflow Library System
- [ ] 6.1. Create workflow storage (JSON files locally)
- [ ] 6.2. Implement workflow CRUD operations
- [ ] 6.3. Add search and filtering by tags/category
- [ ] 6.4. Create workflow sharing/export functionality
- [ ] 6.5. Add workflow versioning and history

### Task 7: Implement Tool Type System
- [ ] 7.1. Create MCP client for MCP tools
- [ ] 7.2. Add HTTP client for API tools
- [ ] 7.3. Integrate LLM processing for LLM tools
- [ ] 7.4. Add parameter validation per tool type
- [ ] 7.5. Create tool discovery and registration

### Task 8: Add Human-in-the-Loop Features
- [ ] 8.1. Create confirmation request system
- [ ] 8.2. Add workflow preview before execution
- [ ] 8.3. Implement step-by-step approval mode
- [ ] 8.4. Add workflow modification during execution
- [ ] 8.5. Create user feedback integration

### Task 9: Deployment Configuration
- [ ] 9.1. Setup Vercel deployment configuration
- [ ] 9.2. Configure Supabase integration (when ready)
- [ ] 9.3. Add environment variable management
- [ ] 9.4. Create local vs cloud deployment options
- [ ] 9.5. Setup monitoring and health checks

### Task 10: Testing & Integration
- [ ] 10.1. Create unit tests for workflow generation
- [ ] 10.2. Test self-healing execution scenarios
- [ ] 10.3. Validate natural language interpretation
- [ ] 10.4. Test all tool types (MCP, API, LLM)
- [ ] 10.5. End-to-end testing with frontend

## API Endpoints

```typescript
// Workflow generation and management
app.post('/chat', chatWithWorkflowGeneration)
app.get('/workflows', getWorkflowLibrary) 
app.post('/workflows', createWorkflow)
app.get('/workflows/:id', getWorkflow)
app.put('/workflows/:id', updateWorkflow)
app.delete('/workflows/:id', deleteWorkflow)

// Execution with self-healing
app.post('/workflows/:id/execute', executeWorkflow)
app.get('/executions/:id', getExecutionStatus)
app.post('/executions/:id/confirm/:stepId', confirmStep)
app.post('/executions/:id/cancel', cancelExecution)

// Real-time updates
app.get('/ws/executions/:id', WebSocket) // Progress updates
```

## Success Metrics
- **Workflow Generation**: 95%+ valid dual-format workflows
- **Self-Healing**: 80%+ automatic error recovery
- **Human Satisfaction**: Clear, encouraging progress updates
- **Performance**: <100ms API responses, <2s workflow generation
- **Deployment**: Works locally and on Vercel seamlessly

## Dependencies (Lightweight)
```json
{
  "dependencies": {
    "hono": "^4.0.0",              // Ultra-lightweight framework
    "@anthropic-ai/sdk": "^0.7.0", // Claude integration
    "@types/node": "^20.0.0",      // TypeScript support
    "ws": "^8.0.0",                // WebSocket support
    "zod": "^3.22.0"               // Runtime validation
  }
}
```

---

*Story created: 2025-08-01*
*Node.js + Hono.js with enhanced dual-format workflows and self-healing execution*