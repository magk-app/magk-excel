# Story 2.2: Workflow to Script Generation

## Story Info

- **Epic:** 2 - Conversational Builder & Tool Generation  
- **Story Number:** 2.2  
- **Status:** Draft  
- **Created:** 2025-07-30  

## Story Statement

**As a** developer, **I want** to implement logic to translate a natural language request into a Python script using modules from Epic 1, **so that** a functional script can be generated.

## Acceptance Criteria

1. The system can parse a simple workflow description.
2. It generates a Python script that correctly calls modules from Epic 1.
3. The script is saved as a temporary file.

## Dev Notes

### Previous Story Insights
From Story 2.1 (Basic Chat Interface):
- Desktop client project structure established with PyQt 6.x GUI framework
- Chat interface implemented for natural language workflow collection
- Backend API client integration completed for communication with serverless backend
- Conversation state management implemented for multi-turn dialogue
- WorkflowConfig parameter extraction logic established for collecting source type, URI, and data identifier

### Data Models
**WorkflowConfig**: This story will process WorkflowConfig objects collected from the chat interface:
- `sourceType`: 'web', 'pdf', or 'excel' (determines which Epic 1 module to use)
- `sourceUri`: URL or file path to the data source (passed to extraction modules)
- `dataIdentifier`: String identifying the specific table or data (used for targeting extraction)
- `outputConfig`: Excel output settings (formatting and save location preferences)
[Source: architecture/data-models.md#WorkflowConfig]

### API Specifications
This story will utilize the existing `/execute-workflow` endpoint for script generation:
- **Purpose**: To process WorkflowConfig and return generated Python script
- **Request Body**: WorkflowConfig object from chat interface
- **Response Enhancement**: Extended to include `{ "scriptContent": "<generated_python_code>", "outputUrl": "<https://s3>..." }`
- The generated script will be returned as text content for local packaging
[Source: architecture/api-specification.md#POST /execute-workflow]

### Component Specifications
**Script Generation Engine**: Amazon Bedrock integration for natural language to code translation
- **Rationale**: Leverages Claude/LLM capabilities for intelligent code generation
- **Location**: Backend service extension in `apps/server/chalicelib/script_generator.py`
- **Integration**: Works with existing Epic 1 modules (web_extractor.py, pdf_extractor.py, excel_handler.py)
[Source: architecture/tech-stack.md#AI Integration]

### File Locations
Based on the established project structure and Epic 1 implementation:
- **Script Generator Module**: `apps/server/chalicelib/script_generator.py`
- **Template Storage**: `apps/server/chalicelib/templates/` (for script templates)
- **Client Script Handler**: `apps/client/src/api/script_manager.py`
- **Tests**: `apps/server/tests/test_script_generator.py`
[Source: architecture/unified-project-structure.md#Project Structure]

### Testing Requirements
**Unit Testing**: 
- Automated unit tests using `pytest` for script generation logic
- Mock Bedrock responses for consistent testing
- Validate generated scripts can execute with Epic 1 modules
- Test various workflow types (web, PDF, Excel) produce correct script structure
[Source: architecture/testing-strategy.md#Unit Testing]

### Technical Constraints
**Script Generation Requirements**:
- Generated scripts must be self-contained Python files
- Scripts must import and correctly call Epic 1 modules
- Error handling must be embedded in generated scripts
- Scripts must be compatible with Python 3.10.x
[Source: architecture/tech-stack.md#Backend Language, architecture/error-handling-strategy.md#Generated Scripts]

### Security and Performance Considerations
**Code Generation Security**: 
- Validate generated script content for malicious code injection
- Sanitize user input before sending to Bedrock
- Implement script execution sandboxing for testing
- Ensure generated scripts don't expose sensitive system information
[Source: architecture/security-and-performance.md#Code Generation Security]

## Tasks / Subtasks

### Task 1: Implement script generation backend service (AC: 1, 2)
- [ ] 1.1. Create `apps/server/chalicelib/script_generator.py` module
- [ ] 1.2. Implement Bedrock integration for natural language to Python code translation
- [ ] 1.3. Create prompt engineering templates for different workflow types (web, PDF, Excel)
- [ ] 1.4. Add script validation logic to ensure generated code is syntactically correct
- [ ] 1.5. Implement error handling for Bedrock API failures and invalid generations

### Task 2: Create script template system (AC: 2)
- [ ] 2.1. Create `apps/server/chalicelib/templates/` directory structure
- [ ] 2.2. Design base script template with imports for Epic 1 modules
- [ ] 2.3. Create specialized templates for web extraction workflows
- [ ] 2.4. Create specialized templates for PDF extraction workflows
- [ ] 2.5. Create specialized templates for Excel manipulation workflows
- [ ] 2.6. Implement template parameter substitution system

### Task 3: Integrate script generator with existing API (AC: 2)
- [ ] 3.1. Extend `/execute-workflow` endpoint to include script generation
- [ ] 3.2. Modify response format to include generated script content
- [ ] 3.3. Add request routing logic based on client requirements (script vs execution)
- [ ] 3.4. Implement backward compatibility for existing API consumers
- [ ] 3.5. Add proper error responses for script generation failures

### Task 4: Implement temporary script storage (AC: 3)
- [ ] 4.1. Create secure temporary directory management for generated scripts
- [ ] 4.2. Implement script file naming conventions with unique identifiers
- [ ] 4.3. Add automatic cleanup for old temporary script files
- [ ] 4.4. Create script retrieval mechanism using temporary file identifiers
- [ ] 4.5. Add file permissions and access control for script security

### Task 5: Create client-side script management (AC: 3)
- [ ] 5.1. Create `apps/client/src/api/script_manager.py` for handling generated scripts
- [ ] 5.2. Implement script download and local storage functionality
- [ ] 5.3. Add script validation on client side before local execution
- [ ] 5.4. Create script metadata tracking (creation time, workflow type, etc.)
- [ ] 5.5. Implement script preview functionality for user verification

### Task 6: Integrate with chat interface workflow (AC: 1)
- [ ] 6.1. Extend chat interface to trigger script generation after workflow collection
- [ ] 6.2. Add script generation progress indicators in the chat UI
- [ ] 6.3. Display generated script summary/preview to user for confirmation
- [ ] 6.4. Implement user feedback loop for script refinement
- [ ] 6.5. Add script generation error handling with user-friendly messages

### Task 7: Unit testing implementation
- [ ] 7.1. Create `apps/server/tests/test_script_generator.py` test file
- [ ] 7.2. Write unit tests for Bedrock integration with mocked responses
- [ ] 7.3. Write unit tests for template system and parameter substitution
- [ ] 7.4. Write unit tests for different workflow types (web, PDF, Excel)
- [ ] 7.5. Write unit tests for script validation and error handling
- [ ] 7.6. Write unit tests for temporary file management
- [ ] 7.7. Create integration tests with Epic 1 modules
- [ ] 7.8. Ensure all tests pass using pytest

### Task 8: Script execution validation (AC: 2)
- [ ] 8.1. Implement script execution testing in isolated environment
- [ ] 8.2. Create validation tests for generated scripts with sample data
- [ ] 8.3. Add performance benchmarking for script generation process
- [ ] 8.4. Implement script debugging capabilities for development
- [ ] 8.5. Create script quality metrics and monitoring

## Project Structure Notes

This story extends the existing serverless backend architecture established in Epic 1. The script generation functionality will be added as a new module within the `apps/server/chalicelib/` directory, maintaining consistency with the existing backend organization. The client-side script management will be integrated into the existing desktop client structure. No structural conflicts identified with the current project organization.

## Dev Agent Record

### Agent Model Used
*To be filled in by the Dev Agent during implementation*

### Implementation Notes
*To be filled in by the Dev Agent during implementation*

### Completion Notes  
*To be filled in by the Dev Agent upon story completion*

### Debug Log References
*References to debug log entries will be added here during implementation*

## File List
*Files created/modified during story implementation:*
- [ ] To be updated during implementation

## Change Log
- 2025-07-30: Created story 2.2 based on Epic 2 requirements and progression from story 2.1

---
*Story created: 2025-07-30*