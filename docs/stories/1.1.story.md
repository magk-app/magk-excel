# Story 1.1: Web Data Extraction Foundation

## Story Info

- **Epic:** 1 - Core Automation Engine  
- **Story Number:** 1.1  
- **Status:** Ready for Review  
- **Created:** 2025-07-29  

## Story Statement

**As a** developer, **I want** to create a Python module that can navigate to a URL and extract a specified data table from an HTML page, **so that** MAGK can handle web-based data sources.

## Acceptance Criteria

1. The module accepts a URL and a table identifier.
2. The module successfully returns the data from the specified table.
3. The module can handle basic HTML table structures.

## Dev Notes

### Previous Story Insights
No previous story exists - this is the first story in the project.

### Initial Setup Details
**Task 0 Requirements**:
- Python 3.10.x must be installed
- AWS CLI should be configured for Chalice deployment (but not required for initial development)
- The initial Chalice app will create a simple health check endpoint
- Initial dependencies for `requirements.txt`:
  - chalice==1.31.0
  - selenium==4.16.0
  - pytest==8.0.0
  - boto3==1.34.0 (for AWS services)
- The `.chalice/config.json` will contain basic Lambda configuration
- Client directory structure is created but not implemented in this story

### Data Models
**WorkflowConfig**: This story will work with the WorkflowConfig data model which includes:
- `sourceType`: Will be 'web' for this module
- `sourceUri`: URL to the website containing the data table
- `dataIdentifier`: String to identify the specific table (e.g., table ID or text to find)
[Source: architecture/data-models.md#WorkflowConfig]

### API Specifications
This module will be called from the `/execute-workflow` endpoint:
- **Purpose**: To trigger the data extraction workflow
- **Request Body**: The WorkflowConfig object in JSON format
- **Response**: `{ "outputUrl": "<https://s3>..." }` (A pre-signed URL to download the generated Excel file)
[Source: architecture/api-specification.md#POST /execute-workflow]

### Component Specifications
**Web Scraping Technology**: Selenium 4.x will be used for browser automation and web data extraction
- **Rationale**: Handles dynamic websites effectively
- **Location**: This module will be part of the serverless backend in the chalicelib directory
[Source: architecture/tech-stack.md#Web Scraping]

### File Locations
Based on the project structure, the web data extraction module should be created at:
- **Backend Module**: `apps/server/chalicelib/web_extractor.py`
- **Main API Logic**: Integration in `apps/server/app.py`
- **Tests**: `apps/server/tests/test_web_extractor.py`
[Source: architecture/unified-project-structure.md#Project Structure]

### Testing Requirements
**Unit Testing**: 
- Automated unit tests using `pytest` will be implemented for the core web extraction module
- Tests will be located in the server tests directory
- Primary focus on foundational reliability
[Source: architecture/testing-strategy.md#Unit Testing]

### Technical Constraints
**Python Version**: Python 3.10.x is required for consistency with the backend
**AWS Platform**: Module will run on AWS Lambda functions
**Error Handling**: Use standard Python try/except blocks with CloudWatch logging
[Source: architecture/tech-stack.md#Backend Language, architecture/error-handling-strategy.md#Server-Side]

### Security and Performance Considerations
**HTTPS Communication**: All communication must be over HTTPS
**Performance**: Heavy processing offloaded to backend to keep UI responsive
**AWS Lambda Scaling**: Automatic scaling with Provisioned Concurrency for demo
[Source: architecture/security-and-performance.md#Security, architecture/security-and-performance.md#Performance]

## Tasks / Subtasks

### Task 0: Initial Project Setup
- [x] 0.1. Create project directory structure (`apps/server`, `apps/client`)
- [x] 0.2. Initialize Chalice application in `apps/server`
- [x] 0.3. Create `apps/server/requirements.txt` with initial dependencies
- [x] 0.4. Create `apps/server/.chalice/config.json` for AWS configuration
- [x] 0.5. Set up pytest configuration for testing
- [x] 0.6. Create initial `apps/server/app.py` with basic Chalice routes
- [x] 0.7. Create `.gitignore` entries for Python/Chalice artifacts
- [x] 0.8. Create CI/CD GitHub Actions workflow for automated testing and deployment
- [x] 0.9. Create development environment setup script (`setup.sh`)
- [x] 0.10. Update requirements.txt with additional testing/linting dependencies

### Task 1: Set up web extraction module structure (AC: 1)
- [x] 1.1. Create `apps/server/chalicelib/web_extractor.py` module file
- [x] 1.2. Define module interface accepting URL and table identifier parameters
- [x] 1.3. Set up basic error handling using try/except blocks
- [x] 1.4. Add logging integration for CloudWatch debugging

### Task 2: Implement Selenium-based web navigation (AC: 1, 2)
- [x] 2.1. Configure Selenium WebDriver for headless operation (AWS Lambda compatible)
- [x] 2.2. Implement URL navigation functionality
- [x] 2.3. Add basic error handling for network connectivity issues
- [x] 2.4. Implement timeout mechanisms for page loading

### Task 3: Implement HTML table extraction logic (AC: 2, 3)
- [x] 3.1. Create table identification logic using the provided dataIdentifier
- [x] 3.2. Implement HTML table parsing to extract tabular data
- [x] 3.3. Handle basic HTML table structures (thead, tbody, tr, td elements)
- [x] 3.4. Return data in a structured format (list of lists or similar)

### Task 4: Integrate with backend API workflow (AC: 1, 2)
- [x] 4.1. Integrate web extractor into the Chalice app.py execute-workflow endpoint
- [x] 4.2. Handle WorkflowConfig object parsing for web source type  
- [x] 4.3. Ensure proper response formatting for the API specification
- [x] 4.4. Add error handling for malformed requests

### Task 5: Unit testing implementation
- [x] 5.1. Create `apps/server/tests/test_web_extractor.py` test file
- [x] 5.2. Write unit tests for URL navigation functionality
- [x] 5.3. Write unit tests for table extraction logic
- [x] 5.4. Write unit tests for error handling scenarios
- [x] 5.5. Create mock test data and fixtures for testing
- [x] 5.6. Ensure all tests pass using pytest

### Task 6: AWS Lambda compatibility verification
- [x] 6.1. Verify Selenium configuration works in serverless environment
- [x] 6.2. Test module performance within Lambda execution limits
- [x] 6.3. Validate error logging to CloudWatch
- [x] 6.4. Ensure module meets AWS Lambda deployment requirements

## Project Structure Notes

The current project structure aligns with the defined architecture. The web extraction module will be placed in the `apps/server/chalicelib/` directory as specified in the unified project structure guide. No structural conflicts identified.

## Dev Agent Record

### Agent Model Used
- claude-opus-4-20250514
- claude-sonnet-4-20250514 (for Windows setup improvements)

### Implementation Notes
- Created complete project structure with apps/server and apps/client directories
- Implemented WebExtractor class with multiple table identification strategies (ID, class, CSS selector, text content, data attributes)
- Configured Selenium with Lambda-compatible Chrome options
- Integrated web extraction into Chalice API with proper error handling and CORS support
- Created comprehensive test suite with mocking for external dependencies
- Added CI/CD pipeline with GitHub Actions for automated testing and deployment
- Created development environment setup automation with setup.sh script

### Windows Setup Improvements (2025-07-29)
- Enhanced setup.bat script to eliminate pauses and run completely through
- Added comprehensive error handling with graceful failure modes
- Improved test.bat script with better error reporting and validation
- Created WINDOWS_SETUP_GUIDE.md with detailed troubleshooting instructions
- Added check-env.bat for pre-setup environment validation
- Implemented proper error tracking and user feedback throughout setup process

### Completion Notes  
- All acceptance criteria have been met:
  1. ✓ Module accepts URL and table identifier
  2. ✓ Module successfully returns data from specified table  
  3. ✓ Module handles basic HTML table structures (thead, tbody, tr, td)
- Project is ready for AWS Lambda deployment with proper configuration
- Tests provide good coverage of core functionality and error scenarios
- API endpoint `/execute-workflow` correctly processes WorkflowConfig objects
- Windows development environment setup is now fully automated and robust

### Debug Log References
- Basic test runner created at apps/server/run_basic_tests.py for environment validation
- Lambda compatibility documented in apps/server/lambda_compatibility_notes.md
- Windows setup troubleshooting guide at apps/server/WINDOWS_SETUP_GUIDE.md

## File List
*Files created/modified during story implementation:*
- [x] apps/server/app.py - Main Chalice application with execute-workflow endpoint
- [x] apps/server/requirements.txt - Python dependencies for the project (updated with testing/linting deps)
- [x] apps/server/pytest.ini - Pytest configuration
- [x] apps/server/.chalice/config.json - Chalice deployment configuration
- [x] apps/server/chalicelib/__init__.py - Package initialization
- [x] apps/server/chalicelib/web_extractor.py - Core web extraction module
- [x] apps/server/tests/__init__.py - Test package initialization
- [x] apps/server/tests/test_web_extractor.py - Unit tests for WebExtractor class
- [x] apps/server/tests/test_app.py - Unit tests for Chalice app routes
- [x] apps/server/run_basic_tests.py - Basic validation test runner
- [x] apps/server/lambda_compatibility_notes.md - Lambda deployment documentation
- [x] apps/server/setup.sh - Development environment setup script (Linux/macOS)
- [x] apps/server/setup.bat - Development environment setup script (Windows) - Enhanced with robust error handling
- [x] apps/server/test.bat - Windows test runner script - Enhanced with better error reporting
- [x] apps/server/check-env.bat - Windows environment validation script (NEW)
- [x] apps/server/WINDOWS_SETUP_GUIDE.md - Comprehensive Windows setup troubleshooting guide (NEW)
- [x] .github/workflows/ci.yml - CI/CD pipeline for testing and deployment (cross-platform)
- [x] .gitignore - Updated with Python/Chalice ignore patterns

## Change Log
- 2025-07-29: Added Task 0 for initial project setup with proper directory structure and Chalice initialization
- 2025-07-29: Converted all tasks to checkbox format for better tracking
- 2025-07-29: Added File List section for tracking implementation changes
- 2025-07-29: Completed all implementation tasks - story ready for review
- 2025-07-29: Enhanced Task 0 with CI/CD pipeline and development environment setup (addressing GitHub Actions and dependency installation gaps)
- 2025-07-29: Added Windows compatibility with setup.bat and test.bat scripts, updated CI/CD for cross-platform testing
- 2025-07-29: **Windows Setup Review**: Enhanced setup.bat to eliminate pauses and run completely through, added comprehensive error handling, created detailed troubleshooting guide, and added environment validation script

---
*Story created: 2025-07-29*
*Story updated: 2025-07-29*
*Story completed: 2025-07-29*