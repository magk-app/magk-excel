# Story 1.2: PDF Data Extraction Foundation

## Story Info

- **Epic:** 1 - Core Automation Engine  
- **Story Number:** 1.2  
- **Status:** Done  
- **Created:** 2025-07-29  

## Story Statement

**As a** developer, **I want** to create a Python module that can open a text-based PDF and extract a specified data table, **so that** MAGK can handle PDF-based data sources.

## Acceptance Criteria

1. The module accepts a file path or URL to a PDF and a table identifier.
2. The module correctly parses text-based tables.
3. The module correctly recognizes non-standard number formats (commas, accounting negatives, units).

## Dev Notes

### Previous Story Insights
From Story 1.1 (Web Data Extraction Foundation):
- Project structure is established with `apps/server/chalicelib/` for backend modules
- Chalice application is configured and working with AWS Lambda compatibility
- Error handling pattern established using try/except blocks with CloudWatch logging
- WebExtractor class provides a good architectural pattern to follow for PDF extraction
- Testing strategy uses pytest with comprehensive mocking for external dependencies

### Data Models
**WorkflowConfig**: This story will work with the WorkflowConfig data model which includes:
- `sourceType`: Will be 'pdf' for this module
- `sourceUri`: File path or URL to the PDF document containing the data table
- `dataIdentifier`: String to identify the specific table (e.g., table heading text or page number)
[Source: architecture/data-models.md#WorkflowConfig]

### API Specifications
This module will be called from the `/execute-workflow` endpoint:
- **Purpose**: To trigger the data extraction workflow for PDF sources
- **Request Body**: The WorkflowConfig object in JSON format with sourceType='pdf'
- **Response**: `{ "outputUrl": "<https://s3>..." }` (A pre-signed URL to download the generated Excel file)
[Source: architecture/data-models.md#WorkflowConfig]

### Component Specifications
**PDF Parsing Technology**: PyMuPDF 1.23.x will be used for PDF text extraction and table parsing
- **Rationale**: Excellent performance and accuracy for PDF processing
- **Location**: This module will be part of the serverless backend in the chalicelib directory
- **Integration**: Will follow the same pattern as WebExtractor from Story 1.1
[Source: architecture/tech-stack.md#PDF Parsing]

### File Locations
Based on the project structure and following the pattern from Story 1.1:
- **Backend Module**: `apps/server/chalicelib/pdf_extractor.py`
- **Main API Logic**: Integration in `apps/server/app.py` (extend existing execute-workflow endpoint)
- **Tests**: `apps/server/tests/test_pdf_extractor.py`
[Source: architecture/unified-project-structure.md#Project Structure]

### Testing Requirements
**Unit Testing**: 
- Automated unit tests using `pytest` will be implemented for the core PDF extraction module
- Tests will be located in the server tests directory alongside existing web extractor tests
- Primary focus on foundational reliability following established testing patterns
- Mock PDF files and test data will be created for comprehensive testing
[Source: architecture/testing-strategy.md#Unit Testing]

### Technical Constraints
**Python Version**: Python 3.10.x is required for consistency with the backend
**AWS Platform**: Module will run on AWS Lambda functions with PyMuPDF compatibility
**Error Handling**: Use standard Python try/except blocks with CloudWatch logging following established pattern
**PDF Format Support**: Focus on text-based PDFs (not scanned/image PDFs)
[Source: architecture/tech-stack.md#Backend Language, architecture/error-handling-strategy.md#Server-Side]

### Security and Performance Considerations
**File Handling**: Secure handling of PDF file uploads and processing
**Performance**: PDF processing can be memory-intensive, ensure Lambda memory limits are respected
**AWS Lambda Scaling**: Automatic scaling with consideration for PDF processing overhead
**Data Format Recognition**: Handle various number formats including commas, accounting negatives, and units
[Source: architecture/error-handling-strategy.md#Server-Side]

## Tasks / Subtasks

### Task 1: Set up PDF extraction module structure (AC: 1)
- [ ] 1.1. Create `apps/server/chalicelib/pdf_extractor.py` module file
- [ ] 1.2. Define module interface accepting PDF file path/URL and table identifier parameters
- [ ] 1.3. Set up basic error handling using try/except blocks following WebExtractor pattern
- [ ] 1.4. Add logging integration for CloudWatch debugging

### Task 2: Implement PyMuPDF-based PDF text extraction (AC: 1, 2)
- [ ] 2.1. Configure PyMuPDF for PDF document opening and text extraction
- [ ] 2.2. Implement PDF file handling for both local files and URLs
- [ ] 2.3. Add basic error handling for corrupted or inaccessible PDF files
- [ ] 2.4. Implement page-by-page text extraction with table detection logic

### Task 3: Implement table identification and parsing logic (AC: 2)
- [ ] 3.1. Create table identification logic using the provided dataIdentifier
- [ ] 3.2. Implement text-based table parsing to extract tabular data from PDF text
- [ ] 3.3. Handle various table structures commonly found in PDFs
- [ ] 3.4. Return data in a structured format (list of lists) consistent with WebExtractor

### Task 4: Implement number format recognition (AC: 3)  
- [ ] 4.1. Create number parsing logic for comma-separated numbers (e.g., "1,234.56")
- [ ] 4.2. Implement accounting negative format recognition (e.g., "(123.45)")
- [ ] 4.3. Handle unit recognition and preservation (e.g., "$", "%", "units")
- [ ] 4.4. Ensure proper data type conversion while preserving formatting context

### Task 5: Integrate with backend API workflow (AC: 1)
- [ ] 5.1. Integrate PDF extractor into the Chalice app.py execute-workflow endpoint
- [ ] 5.2. Handle WorkflowConfig object parsing for PDF source type  
- [ ] 5.3. Ensure proper response formatting consistent with web extraction
- [ ] 5.4. Add error handling for malformed PDF requests

### Task 6: Unit testing implementation
- [ ] 6.1. Create `apps/server/tests/test_pdf_extractor.py` test file
- [ ] 6.2. Create sample PDF test files with various table structures
- [ ] 6.3. Write unit tests for PDF file opening and text extraction functionality
- [ ] 6.4. Write unit tests for table identification and parsing logic
- [ ] 6.5. Write unit tests for number format recognition (commas, negatives, units)
- [ ] 6.6. Write unit tests for error handling scenarios
- [ ] 6.7. Create mock test data and fixtures for testing
- [ ] 6.8. Ensure all tests pass using pytest

### Task 7: AWS Lambda compatibility verification
- [ ] 7.1. Verify PyMuPDF configuration works in serverless environment
- [ ] 7.2. Test module performance within Lambda execution limits for various PDF sizes
- [ ] 7.3. Validate error logging to CloudWatch
- [ ] 7.4. Ensure module meets AWS Lambda deployment requirements

## Project Structure Notes

The current project structure aligns with the defined architecture. The PDF extraction module will be placed in the `apps/server/chalicelib/` directory as specified in the unified project structure guide, following the same pattern established by the WebExtractor module in Story 1.1. No structural conflicts identified.

## Dev Agent Record

### Agent Model Used
*To be filled in by the Dev Agent during implementation*

### Implementation Notes
*To be filled in by the Dev Agent during implementation*

### Completion Notes  
*To be filled in by the Dev Agent upon story completion*

### Debug Log References
*References to debug log entries will be added here during implementation*

## File List
*Files created/modified during story implementation:*
- [ ] To be updated during implementation

## Change Log
- 2025-07-29: Created story 1.2 based on Epic 1 requirements and architecture documentation

---
*Story created: 2025-07-29*