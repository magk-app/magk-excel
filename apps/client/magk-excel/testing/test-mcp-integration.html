<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Integration Test</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        h1 { color: #4CAF50; }
        h2 { color: #81C784; margin-top: 30px; }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #4CAF50;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #45a049; }
        .response {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { border-left: 4px solid #4CAF50; }
        .error { border-left: 4px solid #f44336; }
        .info { color: #81C784; font-weight: bold; }
        input[type="file"] {
            margin: 10px 0;
            padding: 5px;
            background: #3a3a3a;
            border: 1px solid #555;
            color: #e0e0e0;
            border-radius: 4px;
        }
        .file-info {
            background: #3a3a3a;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>ðŸ”§ MCP Integration Test Suite</h1>
    <p>Test the MCP server integration and Excel file handling capabilities</p>

    <div class="test-section">
        <h2>1. Test MCP Tool Execution</h2>
        <p>Directly test MCP tool execution through the chat API</p>
        <button onclick="testDirectToolCall()">Test Excel Write Tool</button>
        <button onclick="testExcelRead()">Test Excel Read Tool</button>
        <button onclick="testDescribeSheets()">Test Describe Sheets</button>
        <div id="direct-response" class="response"></div>
    </div>

    <div class="test-section">
        <h2>2. Test File Upload with MCP</h2>
        <p>Upload an Excel file and process it with MCP tools</p>
        <input type="file" id="excel-file" accept=".xlsx,.xls">
        <div id="file-info" class="file-info" style="display:none;"></div>
        <button onclick="uploadAndProcess()">Upload and Process with MCP</button>
        <div id="upload-response" class="response"></div>
    </div>

    <div class="test-section">
        <h2>3. Test Chat with MCP Tool Selection</h2>
        <p>Send a message that triggers automatic MCP tool selection</p>
        <button onclick="testAutoToolSelection()">Test: "Create an Excel file with sample data"</button>
        <button onclick="testWebScraping()">Test: "Scrape data from a website"</button>
        <div id="chat-response" class="response"></div>
    </div>

    <div class="test-section">
        <h2>4. Test Streaming with Tool Execution</h2>
        <p>Test SSE streaming with MCP tool execution</p>
        <button onclick="testStreamingWithTools()">Test Streaming + Tools</button>
        <div id="stream-response" class="response"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000';
        
        // Mock MCP tools for testing
        const mockMCPTools = [
            {
                name: 'excel_write_to_sheet',
                server: 'excel',
                description: 'Write data to an Excel sheet',
                inputSchema: {
                    type: 'object',
                    properties: {
                        file_path: { type: 'string' },
                        sheet_name: { type: 'string' },
                        values: { type: 'array' }
                    }
                }
            },
            {
                name: 'excel_read_sheet',
                server: 'excel',
                description: 'Read data from an Excel sheet',
                inputSchema: {
                    type: 'object',
                    properties: {
                        file_path: { type: 'string' },
                        sheet_name: { type: 'string' },
                        limit: { type: 'number' }
                    }
                }
            },
            {
                name: 'excel_describe_sheets',
                server: 'excel',
                description: 'Get information about sheets in an Excel workbook',
                inputSchema: {
                    type: 'object',
                    properties: {
                        file_path: { type: 'string' }
                    }
                }
            }
        ];

        async function testDirectToolCall() {
            const response = document.getElementById('direct-response');
            response.innerHTML = '<span class="info">Testing Excel Write Tool...</span>';
            
            try {
                const result = await fetch(`${API_BASE}/api/v2/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: 'Create an Excel file with sample employee data',
                        modelConfig: {
                            provider: 'anthropic',
                            model: 'claude-3-5-sonnet-20241022',
                            enableThinking: false
                        },
                        mcpTools: mockMCPTools,
                        mcpServers: { excel: { enabled: true } }
                    })
                });

                const data = await result.json();
                response.innerHTML = `<span class="info">Response:</span>\n${JSON.stringify(data, null, 2)}`;
                
                if (data.mcpToolCalls && data.mcpToolCalls.length > 0) {
                    response.innerHTML += `\n\n<span class="info">Tool Calls Detected:</span>\n${JSON.stringify(data.mcpToolCalls, null, 2)}`;
                }
                
                response.className = 'response success';
            } catch (error) {
                response.innerHTML = `<span class="info">Error:</span> ${error.message}`;
                response.className = 'response error';
            }
        }

        async function testExcelRead() {
            const response = document.getElementById('direct-response');
            response.innerHTML = '<span class="info">Testing Excel Read Tool...</span>';
            
            // First create a test file, then read it
            response.innerHTML += '\n\n<span class="info">Note:</span> Upload an Excel file first to test reading';
        }

        async function testDescribeSheets() {
            const response = document.getElementById('direct-response');
            response.innerHTML = '<span class="info">Testing Describe Sheets Tool...</span>';
            
            response.innerHTML += '\n\n<span class="info">Note:</span> Upload an Excel file first to test describing sheets';
        }

        async function uploadAndProcess() {
            const fileInput = document.getElementById('excel-file');
            const response = document.getElementById('upload-response');
            const fileInfo = document.getElementById('file-info');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                response.innerHTML = '<span class="info">Error:</span> Please select a file first';
                response.className = 'response error';
                return;
            }
            
            const file = fileInput.files[0];
            
            // Display file info
            fileInfo.style.display = 'block';
            fileInfo.innerHTML = `
                <strong>File:</strong> ${file.name}<br>
                <strong>Size:</strong> ${(file.size / 1024).toFixed(2)} KB<br>
                <strong>Type:</strong> ${file.type || 'Unknown'}
            `;
            
            response.innerHTML = '<span class="info">Processing file with MCP tools...</span>';
            
            try {
                // Read file as base64
                const base64 = await fileToBase64(file);
                
                const result = await fetch(`${API_BASE}/api/v2/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: `I've uploaded an Excel file: ${file.name}. Please analyze it and tell me what's in it.`,
                        modelConfig: {
                            provider: 'anthropic',
                            model: 'claude-3-5-sonnet-20241022',
                            enableThinking: false
                        },
                        attachments: [{
                            name: file.name,
                            type: file.type || 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                            size: file.size,
                            content: base64
                        }],
                        mcpTools: mockMCPTools,
                        mcpServers: { excel: { enabled: true } }
                    })
                });

                const data = await result.json();
                response.innerHTML = `<span class="info">Response:</span>\n${JSON.stringify(data, null, 2)}`;
                
                if (data.mcpToolCalls && data.mcpToolCalls.length > 0) {
                    response.innerHTML += `\n\n<span class="info">MCP Tools Used:</span>\n${JSON.stringify(data.mcpToolCalls, null, 2)}`;
                }
                
                if (data.savedFiles) {
                    response.innerHTML += `\n\n<span class="info">Files Saved:</span>\n${JSON.stringify(data.savedFiles, null, 2)}`;
                }
                
                response.className = 'response success';
            } catch (error) {
                response.innerHTML = `<span class="info">Error:</span> ${error.message}`;
                response.className = 'response error';
            }
        }

        async function testAutoToolSelection() {
            const response = document.getElementById('chat-response');
            response.innerHTML = '<span class="info">Testing automatic tool selection...</span>';
            
            try {
                const result = await fetch(`${API_BASE}/api/v2/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: 'Create an Excel file with sample employee data including names, departments, and salaries',
                        modelConfig: {
                            provider: 'anthropic',
                            model: 'claude-3-5-sonnet-20241022',
                            enableThinking: false
                        },
                        mcpTools: mockMCPTools,
                        mcpServers: { excel: { enabled: true } }
                    })
                });

                const data = await result.json();
                response.innerHTML = `<span class="info">Response:</span>\n${data.response || JSON.stringify(data, null, 2)}`;
                
                if (data.mcpToolCalls && data.mcpToolCalls.length > 0) {
                    response.innerHTML += `\n\n<span class="info">Tools Auto-Selected:</span>\n${JSON.stringify(data.mcpToolCalls, null, 2)}`;
                }
                
                response.className = 'response success';
            } catch (error) {
                response.innerHTML = `<span class="info">Error:</span> ${error.message}`;
                response.className = 'response error';
            }
        }

        async function testWebScraping() {
            const response = document.getElementById('chat-response');
            response.innerHTML = '<span class="info">Testing web scraping tool selection...</span>';
            
            try {
                const result = await fetch(`${API_BASE}/api/v2/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: 'Scrape product prices from example.com and save them to Excel',
                        modelConfig: {
                            provider: 'anthropic',
                            model: 'claude-3-5-sonnet-20241022',
                            enableThinking: false
                        },
                        mcpTools: [
                            ...mockMCPTools,
                            {
                                name: 'fetch',
                                server: 'fetch',
                                description: 'Fetch data from a URL'
                            }
                        ],
                        mcpServers: { 
                            excel: { enabled: true },
                            fetch: { enabled: true }
                        }
                    })
                });

                const data = await result.json();
                response.innerHTML = `<span class="info">Response:</span>\n${data.response || JSON.stringify(data, null, 2)}`;
                
                if (data.mcpToolCalls && data.mcpToolCalls.length > 0) {
                    response.innerHTML += `\n\n<span class="info">Tools Selected for Web Scraping:</span>\n${JSON.stringify(data.mcpToolCalls, null, 2)}`;
                }
                
                response.className = 'response success';
            } catch (error) {
                response.innerHTML = `<span class="info">Error:</span> ${error.message}`;
                response.className = 'response error';
            }
        }

        async function testStreamingWithTools() {
            const response = document.getElementById('stream-response');
            response.innerHTML = '<span class="info">Testing SSE streaming with tool execution...</span>\n\n';
            
            try {
                const result = await fetch(`${API_BASE}/api/v2/chat/stream`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: 'Create a simple Excel file with test data',
                        modelConfig: {
                            provider: 'anthropic',
                            model: 'claude-3-5-sonnet-20241022',
                            enableThinking: true
                        },
                        mcpTools: mockMCPTools,
                        mcpServers: { excel: { enabled: true } }
                    })
                });

                const reader = result.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                
                                if (data.type === 'thinking') {
                                    response.innerHTML += '<span class="info">[THINKING]</span> ';
                                } else if (data.type === 'content') {
                                    response.innerHTML = `<span class="info">Streaming:</span>\n${data.content}`;
                                } else if (data.type === 'toolCalls') {
                                    response.innerHTML += `\n\n<span class="info">Tool Calls:</span>\n${JSON.stringify(data.toolCalls, null, 2)}`;
                                } else if (data.type === 'complete') {
                                    response.innerHTML += '\n\n<span class="info">[COMPLETE]</span>';
                                    if (data.mcpToolCalls) {
                                        response.innerHTML += `\n\n<span class="info">Final Tool Calls:</span>\n${JSON.stringify(data.mcpToolCalls, null, 2)}`;
                                    }
                                } else if (data.type === 'error') {
                                    response.innerHTML += `\n\n<span class="info">Error:</span> ${data.error}`;
                                }
                            } catch (e) {
                                console.error('Failed to parse SSE:', e);
                            }
                        }
                    }
                }
                
                response.className = 'response success';
            } catch (error) {
                response.innerHTML += `\n\n<span class="info">Error:</span> ${error.message}`;
                response.className = 'response error';
            }
        }

        // Helper function to convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = error => reject(error);
            });
        }
    </script>
</body>
</html>